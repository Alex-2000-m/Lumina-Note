# Bç«™è§†é¢‘ç¬”è®°åŠŸèƒ½å¼€å‘å†ç¨‹

> è®°å½•å¦‚ä½•ä¸€æ­¥æ­¥å®ç°åœ¨æ¡Œé¢åº”ç”¨ä¸­å†…åµŒ Bç«™è§†é¢‘å¹¶æ”¯æŒå¼¹å¹•åŒæ­¥ç¬”è®°çš„åŠŸèƒ½

## ğŸ¯ æœ€åˆç›®æ ‡

**ç”¨æˆ·çš„åŸå§‹éœ€æ±‚ï¼š**
> è¾¹çœ‹ Bç«™è§†é¢‘è¾¹åšç¬”è®°ï¼Œç¬”è®°èƒ½è‡ªåŠ¨è®°å½•å½“å‰è§†é¢‘æ’­æ”¾æ—¶é—´æˆ³

ç†æƒ³çš„å·¥ä½œæµï¼š
1. åœ¨åº”ç”¨å†…çœ‹è§†é¢‘
2. éšæ—¶ç‚¹å‡»"æ·»åŠ ç¬”è®°"
3. **è‡ªåŠ¨è·å–å½“å‰æ’­æ”¾æ—¶é—´** â† å…³é”®éœ€æ±‚
4. ç¬”è®°å¸¦ç²¾ç¡®æ—¶é—´æˆ³ï¼Œç‚¹å‡»å¯è·³è½¬

---

## ğŸš§ ç¬¬ä¸€é˜¶æ®µï¼šiframe + è‡ªåŠ¨æ—¶é—´åŒæ­¥

### æœ€åˆæƒ³æ³•
ç”¨ `<iframe>` åµŒå…¥ Bç«™æ’­æ”¾å™¨ï¼Œé€šè¿‡ `postMessage` æˆ–è®¿é—® `contentWindow` è·å–æ’­æ”¾æ—¶é—´ï¼š
```html
<iframe src="https://player.bilibili.com/player.html?bvid=BVxxx" />
```
```javascript
// å°è¯•è·å–æ’­æ”¾æ—¶é—´
iframe.contentWindow.postMessage({ action: 'getCurrentTime' }, '*');
// æˆ–è€…ç›´æ¥è®¿é—®
const video = iframe.contentDocument.querySelector('video');
const currentTime = video.currentTime;  // âŒ è·¨åŸŸæ‹’ç»
```

### é‡åˆ°çš„é—®é¢˜
- âŒ **è·¨åŸŸé™åˆ¶** - æ— æ³•è®¿é—® iframe å†…çš„ DOM
- âŒ **CSP é™åˆ¶** - Bç«™çš„ Content-Security-Policy é˜»æ­¢é€šä¿¡
- âŒ **æ— æ³•è·å–æ’­æ”¾æ—¶é—´** - æ ¸å¿ƒéœ€æ±‚æ— æ³•å®ç°ï¼

### ä¸´æ—¶æ–¹æ¡ˆï¼šæ‰‹åŠ¨è®¡æ—¶å™¨
æ—¢ç„¶æ— æ³•è‡ªåŠ¨è·å–æ—¶é—´ï¼Œé‚£å°±ç”¨æ‰‹åŠ¨è®¡æ—¶ï¼š
- ç”¨æˆ·è‡ªå·±æ§åˆ¶è®¡æ—¶å™¨
- æ‰‹åŠ¨è¾“å…¥æ—¶é—´æˆ³

*ä½†è¿™ä¸å¤Ÿä¼˜é›…...*

---

## ğŸ¤” ç¬¬äºŒé˜¶æ®µï¼šå¯»æ‰¾æ›¿ä»£æ–¹æ¡ˆ

### çµæ„Ÿï¼šå¼¹å¹•ï¼

ç”¨æˆ·æå‡ºï¼š*"èƒ½ä¸èƒ½é€šè¿‡å¼¹å¹•æ¥åŒæ­¥ç¬”è®°ï¼Ÿ"*

**æ€è·¯ï¼š**
1. ç”¨æˆ·åœ¨ Bç«™å‘å¼¹å¹•ï¼ˆå¼¹å¹•æœ‰ç²¾ç¡®æ—¶é—´æˆ³ï¼ï¼‰
2. é€šè¿‡ Bç«™ API è·å–è‡ªå·±çš„å¼¹å¹•
3. æŠŠå¼¹å¹•è½¬æ¢æˆç¬”è®°

**ä¼˜åŠ¿ï¼š**
- âœ… å¼¹å¹•è‡ªå¸¦ç²¾ç¡®æ—¶é—´æˆ³ï¼ˆBç«™æœåŠ¡å™¨è®°å½•ï¼‰
- âœ… ä¸éœ€è¦è®¿é—® iframe å†…éƒ¨
- âœ… åªéœ€è¦è°ƒç”¨å…¬å¼€ API

**ä½†æ˜¯è¿˜æœ‰é—®é¢˜ï¼š**
- ç”¨æˆ·éœ€è¦ç™»å½•æ‰èƒ½å‘å¼¹å¹•
- iframe é‡Œæ— æ³•ç™»å½•ï¼ˆcookie éš”ç¦»ï¼‰
- iframe é‡Œå‘å¼¹å¹• CSRF æ ¡éªŒå¤±è´¥

---

## ğŸš§ ç¬¬ä¸‰é˜¶æ®µï¼šå°è¯•è§£å†³ç™»å½•é—®é¢˜

### å°è¯• iframe å„ç§é…ç½®
```html
<iframe 
  src="https://www.bilibili.com/video/BVxxx"
  sandbox="allow-scripts allow-same-origin allow-forms allow-popups"
  allow="autoplay; fullscreen; clipboard-write"
  referrerPolicy="no-referrer-when-downgrade"
/>
```

### ç»“æœ
- âœ… å¯ä»¥åŠ è½½å®Œæ•´ Bç«™é¡µé¢
- âœ… å¯ä»¥ç™»å½•äº†ï¼
- âŒ **ä½†æ˜¯å‘å¼¹å¹• CSRF æ ¡éªŒå¤±è´¥**

ç”¨æˆ·åé¦ˆï¼š*"å¼¹å¹•å‘ä¸å‡ºå»ï¼Œcsrfæ ¡éªŒå¤±è´¥ï¼Œæ€ä¹ˆåŠï¼Ÿ"*

**ç»“è®ºï¼šiframe æ–¹æ¡ˆå½»åº•è¡Œä¸é€š** ğŸ˜

---

## ğŸ”§ ç¬¬å››é˜¶æ®µï¼šç‹¬ç«‹çª—å£æ–¹æ¡ˆ

### æƒ³æ³•
ç”¨ Tauri çš„ `WebviewWindowBuilder` åˆ›å»ºç‹¬ç«‹çª—å£åŠ è½½ Bç«™ï¼š
```rust
WebviewWindowBuilder::new(&app, "video-player", WebviewUrl::External(url))
    .build()?;
```

### ç»“æœ
- âœ… å¯ä»¥ç™»å½•
- âœ… å¯ä»¥å‘å¼¹å¹•
- âŒ **ä½†æ˜¯æ˜¯ç‹¬ç«‹çª—å£**ï¼Œä¸åœ¨ä¸»åº”ç”¨å†…

ç”¨æˆ·åé¦ˆï¼š*"èƒ½ä¸èƒ½ä¸æ˜¯é‚£ç§ç‹¬ç«‹ä¸€ä¸ªçª—å£çš„å½¢å¼ï¼Œæˆ‘è¿˜æ˜¯å¸Œæœ›æ˜¯åœ¨ç¬”è®°è½¯ä»¶å†…éƒ¨"*

---

## ğŸ‰ ç¬¬äº”é˜¶æ®µï¼šå†…åµŒ WebViewï¼ˆå…³é”®çªç ´ï¼ï¼‰

### å‘ç° Tauri 2.0 å¤š WebView åŠŸèƒ½

é€šè¿‡ grep æœç´¢ Tauri æºç ï¼š
```bash
grep -r "add_child" ~/.cargo/registry/src/*/tauri-2*/src --include="*.rs"
```

å‘ç° `Window::add_child()` æ–¹æ³•å¯ä»¥åœ¨åŒä¸€ä¸ªçª—å£å†…æ·»åŠ å¤šä¸ª WebViewï¼

### ä½†æ˜¯é‡åˆ°é—®é¢˜

```rust
// é”™è¯¯ï¼šWebviewBuilder éœ€è¦ unstable feature
use tauri::WebviewBuilder;  // âŒ not found
```

### è§£å†³æ–¹æ¡ˆ
åœ¨ `Cargo.toml` ä¸­å¯ç”¨ unstable featureï¼š
```toml
tauri = { version = "2.0.0", features = ["unstable"] }
```

### å¦ä¸€ä¸ªé—®é¢˜
```rust
// é”™è¯¯ï¼šadd_child æ˜¯ Window çš„æ–¹æ³•ï¼Œä¸æ˜¯ WebviewWindow çš„
let main_window = app.get_webview_window("main")?;
main_window.add_child(...);  // âŒ method not found
```

### ç»§ç»­æŒ–æ˜æºç 
```bash
grep -A 20 "pub struct WebviewWindow" ~/.cargo/...
```

å‘ç°ï¼š
```rust
pub struct WebviewWindow<R: Runtime> {
    pub(crate) window: Window<R>,  // window å­—æ®µæ˜¯ pub(crate)ï¼
    pub(crate) webview: Webview<R>,
}
```

æ— æ³•ç›´æ¥è®¿é—® `window` å­—æ®µï¼

### æœ€ç»ˆè§£å†³
ä½¿ç”¨ `Manager::windows()` è·å–æ‰€æœ‰ Windowï¼š
```rust
let windows = app.windows();  // HashMap<String, Window>
let main_window = windows.get("main")?;
main_window.add_child(webview_builder, position, size)?;
```

**æˆåŠŸäº†ï¼** ğŸ‰

---

## ğŸ“¡ ç¬¬å…­é˜¶æ®µï¼šå¼¹å¹•åŒæ­¥

### é—®é¢˜
ä»å‰ç«¯ç›´æ¥è°ƒç”¨ Bç«™ API ä¼šé‡åˆ° CORS è·¨åŸŸé™åˆ¶

### è§£å†³æ–¹æ¡ˆ
é€šè¿‡ Rust åç«¯ä»£ç† API è¯·æ±‚ï¼š
```rust
#[tauri::command]
pub async fn get_bilibili_cid(bvid: String) -> Result<Option<u64>, AppError> {
    let client = reqwest::Client::new();
    let resp = client.get(&url)
        .header("User-Agent", "Mozilla/5.0")
        .send().await?;
    // ...
}
```

### å¼¹å¹• XML è§£æ
Bç«™å¼¹å¹• API è¿”å› XML æ ¼å¼ï¼š
```xml
<d p="æ—¶é—´,ç±»å‹,å­—å·,é¢œè‰²,æ—¶é—´æˆ³,...">å¼¹å¹•å†…å®¹</d>
```

æ‰‹å†™è§£æå™¨æå–å¼¹å¹•ï¼š
```rust
while let Some(start) = text[pos..].find("<d p=\"") {
    // è§£æå±æ€§å’Œå†…å®¹...
}
```

---

## â© ç¬¬ä¸ƒé˜¶æ®µï¼šæ— åˆ·æ–°è·³è½¬

### æœ€åˆæ–¹æ¡ˆ
é‡æ–°åŠ è½½ WebView å¹¶å¸¦ä¸Šæ—¶é—´å‚æ•°ï¼š
```typescript
await invoke('create_embedded_webview', {
    url: `https://www.bilibili.com/video/BVxxx?t=${seconds}`,
    // ...
});
```

**é—®é¢˜ï¼šä¼šåˆ·æ–°æ•´ä¸ªé¡µé¢**

### æœ€ç»ˆæ–¹æ¡ˆ
é€šè¿‡ `webview.eval()` æ‰§è¡Œ JavaScript ç›´æ¥æ§åˆ¶æ’­æ”¾å™¨ï¼š
```rust
#[tauri::command]
pub async fn seek_video_time(app: AppHandle, seconds: f64) -> Result<(), AppError> {
    if let Some(webview) = app.get_webview("video-webview") {
        let js = format!(r#"
            const video = document.querySelector('video');
            if (video) video.currentTime = {};
        "#, seconds);
        webview.eval(&js)?;
    }
    Ok(())
}
```

**å®Œç¾ï¼ä¸åˆ·æ–°é¡µé¢ç›´æ¥è·³è½¬ï¼** ğŸš€

---

## ğŸ“ æœ€ç»ˆæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Lumina Note ä¸»çª—å£                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                               â”‚  â”‚ ç¬”è®°æ—¶é—´çº¿              â”‚  â”‚
â”‚  â”‚   å†…åµŒ WebView                 â”‚  â”‚                        â”‚  â”‚
â”‚  â”‚   (Bç«™å®Œæ•´é¡µé¢)                â”‚  â”‚ å‰ç¼€: [#] å‘é€: #ç¬”è®°   â”‚  â”‚
â”‚  â”‚   âœ… å¯ç™»å½•                    â”‚  â”‚                        â”‚  â”‚
â”‚  â”‚   âœ… å¯å‘å¼¹å¹•                  â”‚  â”‚ â— 00:07 ä¸œé›ªè²é©¾äºº      â”‚  â”‚
â”‚  â”‚   âœ… é€šè¿‡ JS æ§åˆ¶æ’­æ”¾          â”‚  â”‚ â— 00:10 ä¸œé›ªè²é©¾äºº      â”‚  â”‚
â”‚  â”‚                               â”‚  â”‚                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ [ğŸ¯ åŒæ­¥å¼¹å¹•]           â”‚  â”‚
â”‚                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  [æ—¶é—´æ§åˆ¶æ ] [è®¡æ—¶å™¨] [æ·»åŠ ç¬”è®°]                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  vault/             â”‚
              â”‚  â””â”€ è§†é¢‘ç¬”è®°-BVxxx.md â”‚
              â”‚     (è‡ªåŠ¨ä¿å­˜/åŠ è½½)  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”‘ å…³é”®æŠ€æœ¯ç‚¹

1. **Tauri 2.0 unstable feature** - å¯ç”¨å¤š WebView æ”¯æŒ
2. **Window::add_child()** - åœ¨ä¸»çª—å£å†…æ·»åŠ å­ WebView
3. **Manager::windows()** - è·å–åº•å±‚ Window å¯¹è±¡
4. **reqwest** - Rust ç«¯ä»£ç† Bç«™ API
5. **webview.eval()** - æ³¨å…¥ JS æ§åˆ¶æ’­æ”¾å™¨

---

## ğŸ“š å­¦åˆ°çš„æ•™è®­

1. **é‡åˆ°é™åˆ¶æ—¶ï¼Œçœ‹æºç ** - grep æœç´¢æºç å‘ç°éšè— API
2. **iframe çš„å±€é™æ€§** - CSRF å’Œ cookie éš”ç¦»éš¾ä»¥ç»‘è¿‡
3. **Tauri çš„å¼ºå¤§** - å¯ä»¥æ·±åº¦æ§åˆ¶ WebView
4. **åç«¯ä»£ç†** - è§£å†³ CORS çš„ä¸‡èƒ½æ–¹æ¡ˆ
5. **JS æ³¨å…¥** - å¯ä»¥æ§åˆ¶ç¬¬ä¸‰æ–¹ç½‘é¡µçš„è¡Œä¸º

---

## ğŸ¬ ä¸‹ä¸€æ­¥å¯èƒ½çš„æ”¹è¿›

- [ ] è‡ªåŠ¨è·å–å½“å‰æ’­æ”¾æ—¶é—´ï¼ˆè½®è¯¢ video.currentTimeï¼‰
- [ ] è§†é¢‘æˆªå›¾åŠŸèƒ½
- [ ] AI æ€»ç»“å¼¹å¹•/ç¬”è®°
- [ ] æ”¯æŒæ›´å¤šè§†é¢‘å¹³å°ï¼ˆYouTubeã€ä¼˜é…·ç­‰ï¼‰

---

*è®°å½•äº 2024-11-30ï¼ŒLumina Note å¼€å‘è¿‡ç¨‹*
